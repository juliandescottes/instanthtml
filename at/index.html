<!DOCTYPE html>
<html lang="en">
<head>
<title>Instant Aria Templates!</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div style="display:none">
        <div>
            <div id="editor-template" >{macro main()}
<ul>
    {foreach fruit in data.fruits}
        ${fruit}, 
    {/foreach}
    </ul>
{/macro}</div>
        <div id="editor-script">{
    $classpath:'TestScript',
    $prototype : {
        myMethod : function () {

        }
    }
}</div>
<div id="editor-css">{macro main()}
    ul {
        padding-left : 10px;
        color:red;
    }   
{/macro}</div>
        </div>
    </div>
    <div id="editors-container">
        <div class="tab-panel">
            <div id="tab-template" class="tab-item tab-selected" onclick="selectEditor(event)">Template</div>
            <div id="tab-script" class="tab-item" onclick="selectEditor(event)">Script</div>
            <div id="tab-css" class="tab-item" onclick="selectEditor(event)">CSS</div>
        </div>
        <div id="editor"></div>
    </div>
    
    <div id="model">var data = {
    fruits : ["Banana", "Orange", "Apple"]
}</div>
    <div id="preview"></div>
    <script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="aria/ariatemplates-1.3.3.js" type="text/javascript"></script><script src="aria/css/atskin-1.3.3.js" type="text/javascript"></script>
    <script>
        var editors = {
            template : document.getElementById("editor-template").innerHTML,
            script : document.getElementById("editor-script").innerHTML,
            css : document.getElementById("editor-css").innerHTML
        }
        var frame = document.getElementById("preview");
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/idle_fingers");
        editor.setFontSize("14px");
        editor.getSession().setMode("ace/mode/html");
        editor.getSession().setValue(editors.template,0);

        var type = "template", unplugged = false;
        selectEditor = function (evt) {
            document.getElementById("tab-" + type).className = "tab-item";
            type = evt.target.innerHTML.toLowerCase(); 
            document.getElementById("tab-" + type).className = "tab-item tab-selected";
            unplugged = true;
            editor.getSession().setValue(editors[type],0);
            unplugged = false;
        };

        var model_editor = ace.edit("model");
        model_editor.setFontSize("14px");
        model_editor.getSession().setMode("ace/mode/javascript");

        var loadTemplateInPreview = function (classDef, data) {
            Aria["eval"](classDef); 
            Aria.loadTemplate({
                classpath: "Test",
                div: "preview",
                data: data
            });
        };

        var loadModel = function (model_content) {
            try {
                eval(model_content);    
            } catch (e) {
                console.error("[MODEL COMPILATION ERROR] : " + e.message);
                var data = {};
            }

            return data;
        };

        var loadTemplate = function (tpl_content, data) {
            var tplString = "{Template {$classpath : 'Test', $hasScript:true, $css:['TestStyle']}}"+tpl_content+"{/Template}"
            aria.templates.TplClassGenerator.parseTemplate(tplString, false,
                {
                    fn : function (res, args) {
                        if (res.classDef) {
                            loadTemplateInPreview(res.classDef, data)
                        } else {
                            console.error("Your template is not compiling")
                        }
                        
                    }
                },{"file_classpath" : "Test"}
            );
        };

        var loadTemplateScript = function (script_content) {
            try {
                eval("Aria.tplScriptDefinition("+script_content+");");
            } catch (e) {
                console.error("[SCRIPT ERROR] : " + e.message);
            }
        };

        var loadTemplateStyle = function (css_content, data) {
            var tplString = "{CSSTemplate {$classpath : 'TestStyle'}}"+css_content+"{/CSSTemplate}"
            aria.templates.CSSClassGenerator.parseTemplate(tplString, false,
                {
                    fn : function (res, args) {
                        if (res.classDef) {
                            Aria["eval"](res.classDef); 
                        } else {
                            console.error("Your CSS template is not compiling")
                        }
                        
                    }
                },{"file_classpath" : "TestStyle"}
            );
        };

        var onchange = function(){
            if(!unplugged) {
                editors[type] = editor.getValue();

                var data = loadModel(model_editor.getValue());
                loadTemplateScript(editors.script);
                loadTemplateStyle(editors.css, data);  
                loadTemplate(editors.template, data);  
                aria.templates.TemplateManager.unloadTemplate("Test");
                aria.templates.CSSMgr.unloadClassPathDependencies("Test", ["TestStyle"]);
            }
        };

        editor.on("change", onchange);
        model_editor.on("change", onchange);

        // loading fake template to get necessary dependencies
        Aria.loadTemplate({classpath: "A",div: "preview",data:{}}, {fn : onchange, scope : null});

    </script>
</body>
</html>